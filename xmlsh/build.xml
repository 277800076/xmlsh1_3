<?xml version="1.0" ?>
<project default="main">

	
    <target name="main" depends="clean, compile, jar" description="Main target">
        <echo>
            Building xmlsh
        </echo>
    </target>
	
	
	<property name="dist" location="_dist"/>
	 <tstamp prefix="bdate"/>
	<property name="release" value="b1_${bdate.DSTAMP}"/>
		
	<target name="clean" description="Clean all">
		  <delete includeEmptyDirs="true" quiet="true">
		    <fileset dir="${dist}" includes="*"/>
		  	<fileset dir="_out" includes="**/*" />
		  	<fileset dir="test" includes="**/_out.txt"/>
		  	<fileset dir="src" includes="**/version.properties"/>
			<fileset dir="bin" includes="**/*" />
		  	<fileset dir="." includes="xmlsh.log" />
		  </delete>
	</target>

  
    <target name="compile" description="Compilation target">
  		<mkdir dir="_out"/>
    	<echo file="src/shell/org/xmlsh/sh/shell/version.properties" append="false">
version.build_date=${bdate.DSTAMP} ${bdate.TSTAMP}
version.release=${release}
</echo>
    	 <javac destdir="_out" debug="on" source="1.6" target="1.6">
    	        <src path="src/core" />
    	 		<src path="src/shell"/>
        	 	<src path="src/commands"/>
    	 		<src path="src/saxon"/>
    	 	<classpath>
    				<fileset dir="lib">
    	                  	<include name="**/*.jar"/>
    				</fileset>
    				 <fileset dir="build-lib">
    	                  	<include name="**/*.jar"/>
    				</fileset>
    	            </classpath>
    	        </javac>
    	 <copy todir="_out" filtering="on">
    	            <fileset dir="src/shell">
    	                <include name="**/*.properties"/>
    	            </fileset>
    	 			<fileset dir="src/commands">
    	 				<include name="**/*.xsh"/>
    	 				<include name="**/*.xsl"/>		
    	 			</fileset>
    	        </copy>

   	</target>
  
  <target name="jar" description="Build JAR - jar">
		<mkdir dir="bin"/>
        <jar 
        jarfile="bin/xmlsh.jar" 
        basedir="_out" 
        manifest="src/WEB-INF/MANIFEST.MF"
        />

  </target>
  <target name="test" description="Test Cases">
  	<java 
  		classname="org.xmlsh.sh.shell.Shell"
  		classpath="bin/xmlsh.jar;lib/log4j-1.2.7.jar;lib/saxon9he.jar;lib/xercesImpl.jar;lib/woodstox-core-asl-4.0.3.jar;lib/stax2-api-3.0.1.jar;lib/stax-utils.jar"
  		fork="true"
  	    dir="test">
  			<arg value="./run_tests.xsh"/>
  			<arg value="extra"/>
  	</java>
  </target>
  <target name="dist" description="Create Distribution">
  		
  		<mkdir dir="${dist}"/>
		<zip destfile="${dist}/xmlsh_${release}.zip" >
			<zipfileset dir="." includes="bin/xmlsh.jar test/** win32/** lib/** samples/** unix/** notices/** license.txt README.txt" 
					excludes="**/sh_histo" prefix="xmlsh_${release}"/>
			
  		</zip>
		<zip destfile="${dist}/xmlsh_src_${release}.zip" >
			<zipfileset dir="." includes="*/**" 
				excludes=".settings/* **/sh_histo _out/** bin/** _dist/** lib/** build-lib/** test/** samples/** win32/** unix/**"  prefix="xmlsh_${release}"/>
		</zip>
  	
  	<!--
		<tar destfile="${dist}/xmlsh_${release}.tar.gz" compression="gzip">
  		  <zipfileset src="_dist/xmlsh_${release}.zip"/>
  		</tar>
		<tar destfile="${dist}/xmlsh_src_${release}.tar.gz" compression="gzip">
		  <zipfileset src="_dist/xmlsh_src_${release}.zip"/>
		</tar>
	-->

  </target>
  
  <mkdir dir="bin"/>
        
   <target name="combine" description="Create Distribution">
  	<jar destfile="bin/xmlsh_all.jar" basedir="_out"
  		index="true"
  		filesetmanifest="merge">
  		
  	    <zipgroupfileset dir="lib" includes="*.jar" />
  	  </jar>
  </target>

</project>